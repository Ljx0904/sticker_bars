<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>绿海贴吧</title>
    <!--引入图标-->
    <link rel="shortcut icon" href="../../images/xx.jpg">
    <link rel="stylesheet" href="../../plugins/element-ui/index.css"/>
    <style>
        html, body {
            width: 85%;
            height: 85%;
            /*font-size: 50px;*/
            min-height: 800px;
            height: auto;
        }

        .titles {
            /*width: 100%;
            height: 120px;
            background-color: #FFFFFF;
            !*background-color: #d3d3d3;*!
            line-height: 90px;
            text-align: center;
            !*margin: 70px 0px 70px 200px;*!
            border-bottom: #000000 solid 1px;
            margin: 60px 0px 0px 0px;*/
            width: 100%;
            font-size: 30px;
            height: 160px;
            text-align: center;
            /*border-bottom: #000000 solid 1px;*/
            margin-top: 100px;
            margin-bottom: 50px;
        }

        .update {
            width: 100px;
            height: 100px;
            margin: 40px 0px;
        }
        .delete{
            float: right;
            margin: 25px 0px 0px 0px;
        }

        .content {
            width: 90%;
            height: 35%;
            /*float: right;*/
            font-size: 20px;
            margin-left: 50px;


            /*background-color: #d3d3d3;*/
        }

        .show-b {
            /*background-color: #d3d3d3;*/
            background-color: #FFFFFF;
            height: auto;
            width: 950px;
            margin-left: 110px;
            min-height: 650px;


        }

        .show-a {
            /*margin-left: 50px;*/
            float: left;
            width: 100%;
            height: 110px;
            /*height: 80%;*/
            /*border-right: #000000 solid 5px;*/
            /*background-color: #E9EBF0;*/
            border-bottom: #000000 solid 1px;
            margin-bottom: 30px;


        }
        .a-{
            width: 225px;
        }

        .a-2 {
            margin: 15px 10px 0px 10px;
            width: 80px;
            height: 80px;
            float: right;
            border-radius: 50px;
        }

        .a-1 {
            /*margin-left: 27px;*/
            color: inherit;
            /*font-synthesis: style;*/
            font-weight: 600;
            font-size: 15px;
            line-height: 80px;
            /*line-height: 1.1;*/
            width: 90px;
            text-align: center;
            margin-top: 20px;
            float: right;
            margin-right: 20px;

        }
        .a-3{
            width: 95px;
            float: right;
            line-height: 50px;

        }

        .update, .delete {
            height: 120px;
            width: 120px;
        }

        .ujd {
            float: right;
            width: 200px;
        }

        pre {
            font-family: auto;
            white-space: pre-wrap;
        }
        ul, ol, li {
            list-style: none;
        }
        .topic_item .topic_name {
            white-space: nowrap;
            text-overflow: ellipsis;
            -o-text-overflow: ellipsis;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            vertical-align: middle;
            color: #666;
        }
        .time {
            font-size: 3px;
            color: #909399;
            margin-top: 10px;
        }
        .ul-b{
            height: auto;
            margin-bottom: 100px;
            margin-top: 38px;
        }
        .user-app{
            width:175px;
        }
        .Nr{
            margin-left: 80px;
        }
        .Nr span:hover{
            cursor: pointer;
        }

        .topic_item2{
            margin-bottom: 10px;
            border-bottom: #A9A9A9 solid 1px;
            padding-bottom: 20px;
        }
        .comments{
            margin-top: 50px;
            border-top: #696969 solid 3px;
        }
        .FBPL{
            height: 115px;
            width: 69%;
            /* margin-bottom: 250px; */
            position: fixed;
            bottom: 25px;
        }
        .FBPL-input{
            font-size: 25px;
            width: 92%;
        }
        .FBPL-button{
            float: right;
            height: 70px;
        }
        .el-input--suffix .el-input__inner {
            padding-left: 30px;
            height: 70px;
        }
        .PLCD{
            background-color: #ffffff;
            width: 69%;
            position: fixed;
            bottom: 70px;
            left: 118px;
            right: 0;
            border-top: 2px solid #333333;
        }
        .PLCD:hover{

        }
        .PLCD li{
            font-size: 17px;
            width: 100%;
            height: 50px;
            line-height: 50px;
            display: block;
            text-align: center;
            border-bottom: 1px solid #e5e5e5;
            cursor: hand;
        }
        .PLCD li:hover{
            cursor:pointer;
        }
        /*.PLCD li.hand:hover{
            cursor: hand;
        }*/
        .PLCD ul{
            margin-right: 30px;
        }
    </style>
</head>
<body>

<div class="show-app" id="show-app">


    <div class="show-b">
        <div class="show-a">
            <div class="ujd">


                <div class="delete" v-if="displayed">
                    <template>
                        <el-button type="text" @click="open">
                            <el-button type="danger" icon="el-icon-delete" circle></el-button>
                        </el-button>
                    </template>
                </div>
                <div class="update" @click="updatePost(shows.id) " v-if="displayed">
                    <el-button type="primary" icon="el-icon-edit" circle></el-button>
                </div>
            </div>
            <div class="a-">
                <div class="a-1">

                    <el-button style="color:#000000; padding: 3px 0; font-size: 20px " type="text" @click="User(tableData.id)">{{this.tableData.name}}</el-button>
<!--                    {{this.tableData.name}}-->
                    <!--            12311-->
                </div>
            <div class="a-2">
                <el-image
                        @click="User(tableData.id)"
                        style="width: 80px; height: 80px; border:none;cursor: pointer;border-radius: 50px;"
                        :src="getImage(tableData.image)">
                        <!--:preview-src-list="[ `/common/download?name=${tableData.image}`]">-->
                    <div slot="error" class="image-slot">
                        <img src="./../../images/noImg.png" style="width: auto; height: 40px; border:none;">
                    </div>
                </el-image>
            </div>

            </div>


        </div>

        <!--<div class="title">
            <h2>{{shows.name}}</h2>
        </div>-->
        <div class="titles">
            <p>{{shows.name}}</p>
        </div>


        <div class="content">
            <pre>{{shows.content}}</pre>
            <el-image
                    style="width: auto; height: 180px; border:none;cursor: pointer;"
                    :src="getImage(shows.image)"
                    :preview-src-list="[ `/common/download?name=${shows.image}`]">
                <div slot="error" class="image-slot">
                    <!--<img src="./../../images/noImg.png"  style="width: auto; height: 40px; border:none;" >-->
                </div>
            </el-image>
            <div class="comments">
                <p >评论( {{this.total}} )</p>

                <div v-if="this.commentsList.length==0" style="height: 200px">
                    <p style="text-align: center;line-height: 150px">还没有评论哦~</p>
                </div>

                <ul class="ul-b" >
                    <li v-for="(comments,index) in commentsList" class="topic_item2" >
                        <!--<div class="delete" v-if="displayed">
                            <template>
                                <el-button type="text" @click="">
                                    <el-button type="danger" icon="el-icon-delete" circle></el-button>
                                </el-button>
                            </template>
                        </div>-->
                        <!--发布人头像和名称-->
                        <div class="user-app">
                            <div class="a-3">

                                <el-button style="color:#000000; padding: 3px 0;font-size: 18px" type="text" @click="User(comments.createUser)">{{comments.userName}}</el-button>
                            </div>
                            <el-image
                                    @click="User(comments.createUser)"
                                    style="width: 60px; height: 60px; border:none;cursor: pointer;border-radius: 50px;"
                                    :src="getImage(comments.userProfile)">
                                <!--:preview-src-list="[ `/common/download?name=${tableData.image}`]">-->
                                <div slot="error" class="image-slot">
                                    <img src="./../../images/noImg.png" style="width: auto; height: 40px; border:none;">
                                </div>
                            </el-image>
                        </div>

                        <!--内容-->
                        <div class="Nr">
                        <span @click="deleteTC()">
                            {{comments.content}}
                        </span>

                            <!--时间-->
                            <div class="time">
                                <i class="el-icon-time"></i>
                                <span>{{comments.createTime}}</span>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="FBPL">

            <el-button type="primary" class="FBPL-button" @click="putPL()">发布</el-button>
            <el-input v-model="content"
                      placeholder="评论千万条, 友善第一条"
                      clearable
                      class="FBPL-input"
            ></el-input>

        </div>
        <div class="PLCD" v-if="cd" >
            <ul>
                <li>举报</li>
                <li>删除</li>
                <li @click="deleteTCS">取消</li>
            </ul>
        </div>






    </div>


</div>
<!--开发环境版本，包含了有帮助的命令行警告-->
<script src="../../plugins/vue/vue.js"></script>
<!-- 引入组件库 -->
<script src="../../plugins/element-ui/index.js"></script>
<!-- 引入axios -->
<script src="../../plugins/axios/axios.min.js"></script>

<script src="../../js/request.js"></script>
<script src="../../js/forum.js"></script>
<script src="../../js/enroll.js"></script>
<script src="../../js/index.js"></script>
<script src="../../js/comments.js"></script>

<!--<script src="../../js/index.js"></script>-->


<script>
    new Vue({
        el: "#show-app",

        data() {
            return {
                id: '',
                shows: {
                    id:'',
                    name:'',
                    employeeId:''

                },
                displayed: false,
                tableData: {},
                menuId:'',
                commentsList:[],
                page:1,
                limit:10,
                total:0,
                content:'',
                userId:'',
                cd:false,

            }

        },
        methods: {
            deleteTC(){
                this.cd=true;
            },
            deleteTCS(){
                this.cd=false;
            },
            async putPL(){
                if (this.content.length<5){
                    this.$message.error('评论不能少于5个字符');
                    return;
                }else if (this.content.length>200){
                    this.$message.error('评论不能多于200个字符');
                    return;
                }
                console.log(this.userId)
                console.log(this.id)
                console.log(this.content)
                var params={
                    /*createUser:this.userId,*/
                    postsId:this.id,
                    content:this.content,
                }
                await addComments(params).then(res => {
                    if (String(res.code) === '1') {
                        this.$message.success("发布成功")
                        this.content=''
                        this.GetComments();
                    }else {
                        this.$message.error(res.msg)
                    }
                }).catch(err => {
                    this.$message.error('请求出错了：' + err)
                })

            },

            getImage(image) {
                // console.log(image)
                return `/common/download?name=${image}`
            },
            async getPostUser() {
                // console.log("========")
                var params = this.shows.employeeId;
                console.log(params)
                await getById(params).then(res => {
                    if (String(res.code) === '1') {
                        console.log(1111111)
                        console.log(res.data)
                        this.tableData = res.data


                        console.log(this.tableData)
                    }
                })/*.catch(err => {
                    this.$message.error('请求出错了：' + err)
                })*/
            },
            open() {
                this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.$message({
                        type: 'success',
                        message: '删除成功!'
                    });
                    this.deletePost(this.shows.id)
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },

            async init() {
                this. id = requestUrlParam('id')
                await  queryPostsById(this.id).then(res => {
                    console.log(res)
                    if (String(res.code) === '1') {
                        console.log(res.data)
                        this.shows = res.data;
                        var userInfo = localStorage.getItem('userInfo');
                        if (userInfo) {
                            var id = JSON.parse(userInfo).id
                            this.userId=id;
                            if (id == this.shows.employeeId) {
                                this.displayed = true
                            }
                            /*if (this.menuId==2){
                                this.displayed = false
                            }*/
                        }
                        this.getPostUser();
                    } else {
                        this.$message.error(res.msg || '操作失败')
                    }
                })


                /*console.log("----");
                window.parent.show((res) => {
                    this.shows = res;
                })
                console.log(this.shows);*/
            },
            updatePost(st) {
                // console.log(st)
                window.parent.menuHandle({
                    id: this.menuId,
                    url: '/front/page/forum/add.html?id=' + st,
                    name: '编辑'
                }, true)
            },

            async deletePost(st) {


                console.info(123)
                await deletePost(st).then(res => {
                    console.info(res)
                    if (String(res.code) === '1') {
                        this.$message.success("删除成功")
                        this.goBack();
                    }
                    this.$message.error(res.msg)
                }).catch(err => {
                    this.$message.error('请求出错了：' + err)
                })
            },
            goBack() {
                window.parent.menuHandle({
                    id: this.menuId,
                    url: '/front/page/forum/forum.html?id='+this.menuId
                }, false)
            },
            User(id){
                window.parent.menuHandle({
                    id: this.menuId,
                    url: '/front/page/user/user.html?id='+id,
                    name: '个人资料'
                },true)
            },
            async GetComments(){
                const data = {
                    page: this.page,
                    pageSize: this.limit,
                    /*type: "1"*/
                    postsId:this.id,
                }
                console.log(this.id);
                await GetCommentsList(data).then(res => {
                    /*console.info(res)*/
                    if (String(res.code) === '1') {
                        this.commentsList=res.data.records;
                        this.total=res.data.total;
                        /*console.log(res.data)*/
                    }
                    this.$message.error(res.msg)
                })/*.catch(err => {
                    this.$message.error('请求出错了：' + err)
                })*/
            },
            scroll() {
                let isLoading = true;//是否有数据可以加载
                window.onscroll = async () => {
                    // 距离底部200px时加载一次
                    let bottomOfWindow = document.documentElement.offsetHeight - document.documentElement.scrollTop - window.innerHeight <= 200;
                    if (bottomOfWindow && isLoading == true) {
                        this.page = this.page + 1;//每次分页+1
                        const data = {
                            page: this.page,
                            pageSize: this.limit,
                            postsId:this.id,
                        }
                        const res = await GetCommentsList(data);//自己封装的请求数据的方法
                        //有数据的时候加载
                        if(res.data.records.length > 0){
                            console.log(res.data)
                            this.commentsList.push(...res.data.records);//追加数据 使用 ...语法
                            isLoading = true;
                        }else{
                            this.$notify({
                                title: '温馨提示：',
                                message: '暂无更多数据信息！',
                                position: 'bottom-right'
                            });
                            isLoading = false;//无数据可以加载
                        }
                    }
                }
            }
        },
        /*生命周期函数-加载完毕执行*/
        mounted(){
            /*this.GetComments();//初次加载*/
            this.scroll();
        },

        created() {
            console.info(this.imageUrl)
            let menuId = window.parent.document.getElementById("zhi").value;

            this.menuId=menuId;

            this.init();
            this.GetComments();



                // console.info(JSON.parse(userInfo).id)
        },




    })
</script>

</body>
</html>